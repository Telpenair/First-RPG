<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Test RPG Game</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>
    <script type="text/javascript">

        //Описание классов
        class Map {
            constructor() {
                game.physics.startSystem(Phaser.Physics.ARCADE);
                this.body = game.add.tilemap('Map', 32, 32);
                this.body.addTilesetImage('Tiles');
                this.layer = this.body.createLayer(0);
                this.layer.resizeWorld();
            }
        }

        class Player {
            constructor(x, y) {
                this.body = game.add.sprite(x, y, 'Player', 1);
                this.body.height = 48;
                this.body.width = 32;
                game.physics.arcade.enable(this.body);
                this.body.collideWorldBounds = true;
                this.cursor = game.input.keyboard.createCursorKeys();

                this.healthbar = game.add.sprite(x, y - 10, 'HealthbarGreen');
                this.healthbar.width = 32;
                this.healthbar.height = 4;

                this.weaponType = 'bow';
                this.arrow = [];
                this.arrow.length = 0;
                this.reload = 0;
                this.body.health = 100;
                this.body.maxHealth = 100;

                this.body.animations.add('left', [3, 4, 5], 7, true);
                this.body.animations.add('right', [6, 7, 8], 7, true);
                this.body.animations.add('up', [9, 10, 11], 7, true);
                this.body.animations.add('down', [0, 1, 2], 7, true);
                this.body.animations.add('idle', [1, 12, 13, 12], 2, true);
            }

            controller() {
                //Коллизия
                game.physics.arcade.collide(this.body, map.layer);

                //Проверка шкалы здоровья
                this.healthbar.x = this.body.x;
                this.healthbar.y = this.body.y - 8;
                this.healthbar.width = 32 * (this.body.health / this.body.maxHealth);

                //Регулятор скорости
                this.body.body.velocity.x = 0;
                this.body.body.velocity.y = 0;

                //Управление игроком
                if (this.cursor.up.isDown) {
                    this.body.body.velocity.y = -100;
                    if (!this.cursor.left.isDown && !this.cursor.right.isDown) {
                        this.body.animations.play('up', true);
                    }
                } else if (this.cursor.down.isDown) {
                    this.body.body.velocity.y = 100;
                    if (!this.cursor.left.isDown && !this.cursor.right.isDown) {
                        this.body.animations.play('down', true);
                    }
                } else {
                    this.body.body.velocity.y = 0;
                    if (!this.cursor.left.isDown && !this.cursor.right.isDown) {
                        this.body.animations.play('idle', true);
                    }
                }

                if (this.cursor.left.isDown) {
                    this.body.body.velocity.x = -100;
                    this.body.animations.play('left', true);
                }
                else if (this.cursor.right.isDown) {
                    this.body.body.velocity.x = 100;
                    this.body.animations.play('right', true);
                } else {
                    this.body.body.velocity.x = 0;
                    if (!this.cursor.up.isDown && !this.cursor.down.isDown) {
                        this.body.animations.play('idle', true);
                    }
                }
            }

            battleController() {
                this.checkArrow();
                this.ArrowHit();

                if (this.reload > 0) {
                    this.reload -= 1;
                }

                if (game.input.activePointer.isDown) {
                    switch (this.weaponType) {
                        case 'bow':
                            if (this.reload <= 0) {
                                this.CreateArrow();
                                this.reload = 25;
                            };
                    }
                }
            }

            checkArrow(){
                
            }

            CreateArrow() {
                const arrowSpeed = 200;

                this.arrow.length += 1;
                this.arrow[this.arrow.length - 1] = game.add.sprite(this.body.x + 26, this.body.y + 36, 'Fireball');
                this.arrow[this.arrow.length - 1].animations.add('fire');
                this.arrow[this.arrow.length - 1].animations.play('fire', 6, true);
                game.physics.arcade.enable(this.arrow[this.arrow.length - 1]);
                this.arrow[this.arrow.length - 1].height = 16;
                this.arrow[this.arrow.length - 1].width = 16;

                this.arrow[this.arrow.length - 1].damage = 25;

                // Vx/Vy = dx/dy;
                // sqr(Vx) + sqr(Vy) = const

                var dx = (game.input.activePointer.x - (this.body.x + 26));
                var dy = (game.input.activePointer.y - (this.body.y + 36));
                var resy = Math.round(Math.sqrt(arrowSpeed * arrowSpeed / ((dx * dx) / (dy * dy) + 1)));
                var resx = Math.round(Math.sqrt(arrowSpeed * arrowSpeed / ((dy * dy) / (dx * dx) + 1)));

                if (dx > 0) {
                    this.arrow[this.arrow.length - 1].body.velocity.x = resx;
                } else {
                    this.arrow[this.arrow.length - 1].body.velocity.x = -resx;
                }

                if (dy > 0) {
                    this.arrow[this.arrow.length - 1].body.velocity.y = resy;
                } else {
                    this.arrow[this.arrow.length - 1].body.velocity.y = -resy;
                }
            }

            DeleteArrow(int) {
                for (var i = 0; i < this.arrow.length; i++) {
                    if (i >= int) {
                        if (this.arrow[i + 1] != null) {
                            this.arrow[i].kill();
                            this.arrow[i] = this.arrow[i + 1];
                        }
                    }
                }
                this.arrow.length -= 1;
            }

            ArrowHit() {
                for (var i = 0; i < this.arrow.length; i++) {
                    for (var j = 0; j < mobs.mob.length; j++) {
                        var dist = 32;
                        var radius = (Math.abs(mobs.mob[j].body.x - this.arrow[i].body.x) + Math.abs(mobs.mob[j].body.y - this.arrow[i].body.y));
                        if (radius <= dist) {
                            mobs.mob[j].body.damage(10);
                            this.DeleteArrow(i);
                        }

                    }
                }
            }
        }

        class Skeleton {
            constructor(x, y) {
                this.body = game.add.sprite(x, y, 'Characters', 7);
                this.body.height = 48;
                this.body.width = 32;
                this.reload = 0;

                game.physics.arcade.enable(this.body);
                this.body.collideWorldBounds = true;

                this.body.health = 50;
                this.body.maxHealth = 50;
                this.healthbar = game.add.sprite(0, 0, 'HealthbarRed');
                this.healthbar.width = 52;
                this.healthbar.height = 8;

                this.body.animations.add('left', [18, 19, 20], 10, true);
                this.body.animations.add('right', [30, 31, 32], 10, true);
                this.body.animations.add('up', [42, 43, 44], 10, true);
                this.body.animations.add('down', [6, 7, 8], 10, true);
            }

            controller() {
                //Коллизия
                game.physics.arcade.collide(this.body, map.layer);

                //Проверка шкалы здоровья
                this.healthbar.x = this.body.x;
                this.healthbar.y = this.body.y - 8;
                this.healthbar.width = 32 * (this.body.health / this.body.maxHealth);

                //Регулятор скорости
                this.body.body.velocity.x = 0;
                this.body.body.velocity.y = 0;

                //Проверка движения
                const dist = 250;
                var radius = (Math.abs(this.body.x - player.body.x) + Math.abs(this.body.y - player.body.y));
                var agr_on = radius < dist;
                var left_on = (player.body.x < (this.body.x - 2));
                var right_on = (player.body.x > (this.body.x + 2));
                var up_on = (player.body.y < this.body.y - 2);
                var down_on = (player.body.y > this.body.y + 2);
                if (agr_on) {
                    if (left_on) {
                        this.body.body.velocity.x = -80;
                        this.body.animations.play('left', true);
                    }
                    else if (right_on) {
                        this.body.body.velocity.x = 80;
                        this.body.animations.play('right', true);
                    }
                    else {
                        this.body.body.velocity.x = 0;
                        if (!up_on && !down_on) {
                            this.body.frame = 7;
                        }
                    }
                    if (up_on) {
                        this.body.body.velocity.y = -80;
                        if (!left_on && !right_on) {
                            this.body.animations.play('up', true);
                        }
                    }
                    else if (down_on) {
                        this.body.body.velocity.y = 80;
                        if (!left_on && !right_on) {
                            this.body.animations.play('down', true);
                        }
                    }
                    else {
                        this.body.body.velocity.y = 0;
                        if (!left_on && !right_on) {
                            this.body.frame = 7;
                        }
                    }
                }
                else {
                    this.body.body.velocity.y = 0;
                    this.body.body.velocity.x = 0;
                    this.body.frame = 7;
                }
            }

            battleController() {
                if (this.reload > 0) {
                    this.reload -= 1;
                }
                player.body.tint = 0xffffff;//Заменить анимацией
                var dist = 50;
                var radius = (Math.abs(this.body.x - player.body.x) + Math.abs(this.body.y - player.body.y));
                if (radius <= dist) {
                    if (this.reload <= 0) {
                        player.body.damage(10);
                        this.reload = 100;
                    } else {
                        player.body.tint = 0xff0000;//Заменить анимацией
                    }

                }
            }
        }

        class Mobs {
            constructor() {
                this.mob = [];
                this.mob.length = 0;
            }

            addMob(x, y, name) {
                this.mob.length += 1;
                switch (name) {
                    case 'Skeleton':
                        this.mob[this.mob.length - 1] = new Skeleton(x, y);
                }
            }

            killMob(int) {
                for (var i = 0; i < this.mob.length; i++) {
                    if (i >= int) {
                        if (this.mob[i + 1] == null) {
                            break;
                        } else {
                            this.mob[i] = this.mob[i + 1];
                        }
                    }
                }
                this.mob[int].body.kill();
                this.mob.length -= 1;
            }

            mobsController() {
                for (var i = 0; i < this.mob.length; i++) {
                    this.mob[i].controller();
                    this.mob[i].battleController();

                    //Проверка смерти
                    if (this.mob[i].body.health <= 0) {
                        this.killMob(i);
                    }
                }
            }
        }

        //Описание переменных
        let game = new Phaser.Game(screen.width, screen.height, Phaser.AUTO, '',
            { preload: preload, create: create, update: update });
        let map;
        let player;
        let mobs;

        function preload() {
            this.load.spritesheet('Characters', 'Assets/Characters.png', 52, 72);
            this.load.spritesheet('Player', 'Assets/Player.png', 38, 64);
            this.load.spritesheet('Fireball', 'Assets/Fireball.png', 29, 29);
            this.load.tilemap('Map', 'Assets/First map.csv', null, Phaser.Tilemap.CSV);
            this.load.image('Tiles', 'Assets/Map tiles.png');
            this.load.image('HealthbarGreen', 'Assets/HealthbarG.png');
            this.load.image('HealthbarRed', 'Assets/HealthbarR.png');
        }

        function create() {
            map = new Map();
            player = new Player(100, 100);
            mobs = new Mobs();
            mobs.addMob(500, 500, 'Skeleton');
            mobs.addMob(400, 400, 'Skeleton');
        }

        function update() {
            player.controller();
            player.battleController();
            mobs.mobsController();
        }

    </script>
</body>

</html>