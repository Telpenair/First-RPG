<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Test RPG Game</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }

    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(1366, 768, Phaser.AUTO, '',
{ preload: preload, create: create, update: update});

function preload() {

    game.load.spritesheet('motw', 'Assets/Characters.png', 52, 72);
    this.load.spritesheet('jack', 'Assets/Jack.png', 38, 64);
    this.load.spritesheet('jack_01', 'Assets/Jack_01.png', 38, 64);
    this.load.spritesheet('_fireball', 'Assets/fireball_comb.png', 29, 29);
    this.load.tilemap('map', 'Assets/first_map.csv', null, Phaser.Tilemap.CSV);
    this.load.image('tiles', 'Assets/Map tiles.png');
    this.load.image('healthbar', 'Assets/healthbarG.png');
    this.load.image('healthbarR', 'Assets/healthbarR.png');
    this.load.image('arrow', 'Assets/Arrow.png');
    this.load.image('fireball', 'Assets/Fireball.png');
}


var player;
var healthbar;
var cursors;
var weaponType = 'bow';
var invulnerability;
const invulnerabilityConst = 180;

var arrow = [];
var reload;
const reloadConst = 180;

const arrowSpeed = 250;

var map;
var layer;

var mob = [];
var healthbarM = [];


function create() {

    //Работа с картой
    game.physics.startSystem(Phaser.Physics.ARCADE);
    map = this.add.tilemap('map', 32, 32);
    map.addTilesetImage('tiles');
    layer = map.createLayer(0);
    layer.resizeWorld();


    map.setCollision(543);
    map.setCollisionBetween(572, 574);
    map.setCollisionBetween(602, 604);

    //Работа с игроком
    player = game.add.sprite(100, 400, 'jack_01', 1);
    invulnerability = 0;
    reload = 0;

    //Стрелы
    arrow.length = 0;

    game.physics.arcade.enable(player);
    player.body.collideWorldBounds = true;

    player.health = 100;
    player.maxHealth = 100;
    healthbar = this.game.add.sprite(0,0,'healthbar');
    healthbar.width = 38;
    healthbar.height = 8;

    cursors = game.input.keyboard.createCursorKeys();

    player.animations.add('left', [3, 4, 5], 7, true);
    player.animations.add('right', [6, 7, 8], 7, true);
    player.animations.add('up', [9, 10, 11], 7, true);
    player.animations.add('down', [0, 1, 2], 7, true);
    player.animations.add('idle', [1, 12, 13, 12], 2, true);

    

    //При реализации камеры (показывает активное оружие на данный момент
    //weaponFrame = game.add.sprite(100, 100, 'weaponFrame');
    //weaponFrame.width = 50;
    //weaponFrame.height = 50;
    //weaponFrame.fixedToCamera = true;

    //Работа с мобами
    for (let i=0; i<10 ; i++ )  {  
        if (i<5){
            mob[i] = game.add.sprite(i*220+150, game.world.height - 132, 'motw', 7);
        }
        else{
            mob[i] = game.add.sprite(game.world.width - 100,  i*120 - 550, 'motw', 7);
        }

        game.physics.arcade.enable(mob[i]);
        mob[i].body.collideWorldBounds = true;

        //Шкала здоровья (Можно сделать красивее без массива шкал здоровья)
        mob[i].health = 50;
        mob[i].maxHealth = 50;
        healthbarM[i] = this.game.add.sprite(0,0,'healthbarR');
        healthbarM[i].width = 52;
        healthbarM[i].height = 8;

        mob[i].animations.add('left', [18, 19, 20], 10, true);
        mob[i].animations.add('right', [30, 31, 32], 10, true);
        mob[i].animations.add('up', [42, 43, 44], 10, true);
        mob[i].animations.add('down', [6, 7, 8], 10, true);

    }
    
}

function update() {
    //Работа с указателями здоровья
    healthbar.x = player.x;
    healthbar.y = player.y - 10;
    healthbar.width = 52*(player.health/player.maxHealth);

    //Реализация коллизии
    game.physics.arcade.collide(player, layer);

    //Контроль скорости игрока
    player.body.velocity.x = 0;
    player.body.velocity.y = 0;

    //Агрессивность скелетов
    for (j=0;j<10;j++){

        //Проверка возможности удара (Реализовать красивее)
        SkeletonHitPlayer(player,mob[j]);

        //Работа с указателями здоровья
        healthbarM[j].x = mob[j].x;
        healthbarM[j].y = mob[j].y - 10;
        healthbarM[j].width = 52*(mob[j].health/mob[j].maxHealth);

        //Проверка попаданий
        for (i = 0; i < arrow.length; i++){
            ArrowHit(mob[j],arrow[i]);
        }

        //Реализация коллизии (Нужна ли коллизия между скелетами?)
        game.physics.arcade.collide(mob, layer);
        game.physics.arcade.collide(mob, mob);

        //Проверка расстояния до игрока
        let agr_dist = 200
        let radius =  (Math.abs(mob[j].x - player.x) + Math.abs(mob[j].y - player.y));
        let agr_on = radius < agr_dist;
        let left_on = (player.x < (mob[j].x - 2));
        let right_on = (player.x > (mob[j].x + 2));
        let up_on = (player.y < mob[j].y - 2);
        let down_on = (player.y > mob[j].y + 2);
        if (agr_on){
            if(left_on){
                mob[j].body.velocity.x = -80;
                mob[j].animations.play('left', true);
            }
            else if(right_on){
                mob[j].body.velocity.x = 80;
                mob[j].animations.play('right', true);
            }
            else{
                mob[j].body.velocity.x = 0;
                if(!up_on && !down_on){
                    mob[j].frame = 7;
                }
            }
            if(up_on){
                mob[j].body.velocity.y = -80;
                if(!left_on && !right_on){
                    mob[j].animations.play('up', true);
                }  
            }
            else if(down_on){
                mob[j].body.velocity.y = 80;
                if(!left_on && !right_on){
                    mob[j].animations.play('down', true);
                }    
            }
            else{
                mob[j].body.velocity.y = 0;
                if(!left_on && !right_on){
                    mob[j].frame = 7;
                } 
            }
        }
        else{
            mob[j].body.velocity.y = 0;
            mob[j].body.velocity.x = 0;
            mob[j].frame = 7;
        }



    //Проверка неуязвимости
        if (invulnerability > 0){
            player.tint = 0xff0000;
            invulnerability -= 1;
        }else{
            player.tint = 0xffffff;
        }
        
    //Проверка перезарядки
        if (reload > 0){
            reload -= 1;
        }

    }

    //Управление игроком
    if (game.input.activePointer.isDown){
        switch(weaponType){
            case 'bow': PlayerBow(player);
        }
    }

    if(cursors.up.isDown){
        player.body.velocity.y = -100;
        if(!cursors.left.isDown && !cursors.right.isDown){
            player.animations.play('up', true);
        }
    }
    else if(cursors.down.isDown)
    {
        player.body.velocity.y = 100;
        if(!cursors.left.isDown && !cursors.right.isDown){
            player.animations.play('down', true);
        }
    }else{
        player.body.velocity.y = 0;
        if(!cursors.left.isDown && !cursors.right.isDown){
            player.animations.play('idle', true);
        }
    }

    if(cursors.left.isDown){
        player.body.velocity.x = -100;
        player.animations.play('left', true);
    }
    else if(cursors.right.isDown)
    {
        player.body.velocity.x = 100;
        player.animations.play('right', true);
    }else{
        player.body.velocity.x = 0;
        if(!cursors.up.isDown && !cursors.down.isDown){
            player.animations.play('idle', true);
        }
    }
}

    function SkeletonHitPlayer(player, mob){
            
        let agr_dist = 40;
        let radius =  (Math.abs(mob.x - player.x) + Math.abs(mob.y - player.y));
        if (radius <= agr_dist){
            if ((invulnerability <= 0) && (mob.health > 0)){
                player.damage(6);
                invulnerability = invulnerabilityConst;
            }

        }            
    }

    function PlayerBow(player){
        
        if (reload <= 0){
                CreateArrow();
                reload = reloadConst;
            }
    }

    function ArrowHit(mob,arrow){

        let agr_dist = 45;
        let radius =  (Math.abs(mob.x+26 - arrow.x+12) + Math.abs(mob.y+36 - arrow.y+12));
        if (radius <= agr_dist){
                mob.damage(10);
        }  
    }

    function CreateArrow(){

        arrow.length += 1;
        arrow[arrow.length - 1] = game.add.sprite(player.x+26,player.y+36,'_fireball');
        arrow[arrow.length - 1].animations.add('fire');
        arrow[arrow.length - 1].animations.play('fire', 6, true);
        game.physics.arcade.enable(arrow[arrow.length - 1]);
        game.input.activePointer.x;
        arrow[arrow.length - 1].height = 60;
        arrow[arrow.length - 1].width = 60;
        
                // Vx/Vy = dx/dy;
                // sqr(Vx) + sqr(Vy) = const

                dx = (game.input.activePointer.x - (player.x +26));
                dy = (game.input.activePointer.y - (player.y +36));
                resy = Math.round(Math.sqrt(arrowSpeed*arrowSpeed/((dx*dx)/(dy*dy) + 1)));
                resx = Math.round(Math.sqrt(arrowSpeed*arrowSpeed/((dy*dy)/(dx*dx) + 1)));

                if (dx > 0){
                    arrow[arrow.length - 1].body.velocity.x = resx;
                }else{
                    arrow[arrow.length - 1].body.velocity.x = -resx;
                }

                if (dy > 0){
                    arrow[arrow.length - 1].body.velocity.y = resy;
                }else{
                    arrow[arrow.length - 1].body.velocity.y = -resy;
                }
                
                //Добавить таймер с удаление объекта
    }

</script>

</body>
</html>